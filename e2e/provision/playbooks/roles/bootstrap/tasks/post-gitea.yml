---
# SPDX-license-identifier: Apache-2.0
##############################################################################
# Copyright (c) 2023 The Nephio Authors.
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

- name: Query the external gitea IP address
  ansible.builtin.command: kubectl get services -n gitea gitea -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
  register: gitea_ip_result
  until: "gitea_ip_result is succeeded"
  retries: 10
  delay: 10
  changed_when: "gitea_ip_result is succeeded"

- name: Query the external gitea TCP port
  ansible.builtin.command: kubectl get services -n gitea gitea -o jsonpath='{.spec.ports[?(@.name=="http")].port}'
  register: gitea_port_result
  changed_when: "gitea_port_result is succeeded"


- name: Set local git facts
  ansible.builtin.set_fact:
    local_git:
      push_uri: http://{{ gitea.k8s.username }}:{{ gitea.k8s.password }}@{{ gitea_ip_result.stdout }}:{{ gitea_port_result.stdout }}/nephio
      fetch_uri: http://{{ gitea_ip_result.stdout }}:{{ gitea_port_result.stdout }}/nephio
