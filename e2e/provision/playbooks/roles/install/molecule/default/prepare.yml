---
# SPDX-license-identifier: Apache-2.0
##############################################################################
# Copyright (c) 2023 The Nephio Authors.
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

- name: Include the kpt role's prepare playbook
  ansible.builtin.import_playbook: ../../../kpt/molecule/default/prepare.yml

- name: Deploy Gitea
  hosts: all
  pre_tasks:
    - name: Update Apt cache
      ansible.builtin.raw: apt-get update --allow-releaseinfo-change
      become: true
      changed_when: false
      when: ansible_distribution == 'Ubuntu'
    - name: Install pip package
      become: true
      ansible.builtin.package:
        name: python3-pip
        state: present
      when: ansible_distribution == 'Ubuntu'
    - name: Install kubernetes python package
      become: true
      ansible.builtin.pip:
        name: kubernetes==26.1.0
  tasks:
    - name: Set local git facts
      ansible.builtin.include_tasks: ../../../bootstrap/tasks/prep-gitea.yml
    - name: Deploy gitea kpt packages
      ansible.builtin.include_role:
        name: kpt
      vars:
        repo_uri: "{{ nephio_example_repo_uri }}"
        pkg: "{{ item }}"
        version: "{{ nephio_pkg_version }}"
        context: "{{ k8s.context }}"
        kpt_async: 1020
        kpt_poll: 5
      loop:
        - gitea
        - metallb
        - metallb-sandbox-config
    - name: Wait for deployments
      ansible.builtin.include_tasks: ../../tasks/wait_deployments.yml
      loop_control:
        loop_var: namespace
      vars:
        context: "{{ k8s.context }}"
      loop:
        - gitea
        - metallb-system
