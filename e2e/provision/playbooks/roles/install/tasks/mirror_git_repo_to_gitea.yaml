- name: "Create gitea repo: {{ item.name }}"
  kubernetes.core.k8s:
    context: "{{ k8s.context }}"
    state: present
    definition:
      apiVersion: infra.nephio.org/v1alpha1
      kind: Repository
      metadata:
        name: "{{ item.name }}"
        namespace: default
      spec:
        description: "{{ item.name }} repository"
        defaultBranch: main

- name: "Pull GitHub repo {{ item.name }}"
  ansible.builtin.git:
    repo: "{{ item.repo }}"
    dest: "/tmp/repository/{{ item.name }}.git"
    bare: yes

- name: "Add gitea remote to local git repo"
  ansible.builtin.command:
    cmd: "git remote add gitea http://{{ gitea.k8s.username }}:{{ gitea.k8s.password }}@{{ gitea_ip }}:3000/nephio/{{ item.name }}.git"
    chdir: "/tmp/repository/{{ item.name }}.git"

- name: "Push tags to gitea: {{ item.name }}"
  ansible.builtin.command:
    cmd: git push gitea --tags --force
    chdir: /tmp/repository/{{ item.name }}.git
  environment:
    no_proxy: "{{ gitea_ip}}"
    NO_PROXY: "{{ gitea_ip}}"
  register: push_result
  until: push_result is not failed
  retries: 60
  delay: 10

- name: "Push branches to gitea: {{ item.name }}"
  ansible.builtin.command:
    cmd: git push gitea --all --force
    chdir: /tmp/repository/{{ item.name }}.git
  environment:
    no_proxy: "{{ gitea_ip}}"
    NO_PROXY: "{{ gitea_ip}}"

- name: "Create porch repository object: {{ item.name }}"
  kubernetes.core.k8s:
    context: "{{ k8s.context }}"
    state: present
    definition:
      apiVersion: config.porch.kpt.dev/v1alpha1
      kind: Repository
      metadata:
        name: "{{ item.name }}"
        namespace: default
        labels:
          kpt.dev/repository-access: read-only
          kpt.dev/repository-content: external-blueprints
      spec:
        content: Package
        deployment: false
        git:
          branch: "{{ item.branch }}"
          directory: /
          repo: "http://{{ gitea_ip }}:3000/nephio/{{ item.name }}.git"
        type: git
