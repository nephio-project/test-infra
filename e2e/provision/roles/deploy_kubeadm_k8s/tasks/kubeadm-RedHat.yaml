- name: install kubelet kubeadm kubectl on {{ ansible_os_family }} system
  become: true
  block:
    - name: install iptables-legacy package
      ansible.builtin.package:
        name:
          - iptables-legacy

    - name: add k8s yum repository
      ansible.builtin.yum_repository:
        name: Kubernetes
        description: Kubernetes Repository
        baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-$basearch
        enabled: yes
        gpgcheck: yes
        repo_gpgcheck: yes
        gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
        #exclude: kubelet kubeadm kubectl

    - name: put SELinux in permissive mode
      ansible.posix.selinux:
        policy: targeted
        state: permissive

    - name: install kubelet kubeadm kubectl
      ansible.builtin.dnf:
        name:
          - kubelet <= {{ k8s_ver }}
          - kubeadm <= {{ k8s_ver }}
          - kubectl <= {{ k8s_ver }}
        state: present

    - name: disable swap 1/2
      become: true
      ansible.builtin.shell: swapoff -a

    - name: disable swap in fstab 2/2
      become: true
      replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
        replace: '# \1'

    - name: remove zram-generator-defaults package
      ansible.builtin.package:
        name: zram-generator-defaults
        state: absent
